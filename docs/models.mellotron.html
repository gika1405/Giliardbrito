---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/models.mellotron.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/models.mellotron.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><h1>Table of Contents<span class="tocSkip"></span></h1></p>
<div class="toc"><ul class="toc-item"><li><span><a href="#Decoder" data-toc-modified-id="Decoder-1"><span class="toc-item-num">1&nbsp;&nbsp;</span>Decoder</a></span></li><li><span><a href="#Tacotron2-Model" data-toc-modified-id="Tacotron2-Model-2"><span class="toc-item-num">2&nbsp;&nbsp;</span>Tacotron2 Model</a></span></li><li><span><a href="#Tests" data-toc-modified-id="Tests-3"><span class="toc-item-num">3&nbsp;&nbsp;</span>Tests</a></span><ul class="toc-item"><li><span><a href="#Test-without-f0s,-forward-pass" data-toc-modified-id="Test-without-f0s,-forward-pass-3.1"><span class="toc-item-num">3.1&nbsp;&nbsp;</span>Test without f0s, forward pass</a></span></li><li><span><a href="#Test-without-f0s,-inference" data-toc-modified-id="Test-without-f0s,-inference-3.2"><span class="toc-item-num">3.2&nbsp;&nbsp;</span>Test without f0s, inference</a></span></li><li><span><a href="#Test-with-f0s" data-toc-modified-id="Test-with-f0s-3.3"><span class="toc-item-num">3.3&nbsp;&nbsp;</span>Test with f0s</a></span></li><li><span><a href="#Testing-n_frames_per_step" data-toc-modified-id="Testing-n_frames_per_step-3.4"><span class="toc-item-num">3.4&nbsp;&nbsp;</span>Testing n_frames_per_step</a></span><ul class="toc-item"><li><span><a href="#Forward-pass" data-toc-modified-id="Forward-pass-3.4.1"><span class="toc-item-num">3.4.1&nbsp;&nbsp;</span>Forward pass</a></span></li><li><span><a href="#Test-inference-with-n_frames_per_step->-1" data-toc-modified-id="Test-inference-with-n_frames_per_step->-1-3.4.2"><span class="toc-item-num">3.4.2&nbsp;&nbsp;</span>Test inference with n_frames_per_step &gt; 1</a></span></li><li><span><a href="#Test-inference-with-f0s-and-n_frames_per_step->-1" data-toc-modified-id="Test-inference-with-f0s-and-n_frames_per_step->-1-3.4.3"><span class="toc-item-num">3.4.3&nbsp;&nbsp;</span>Test inference with f0s and n_frames_per_step &gt; 1</a></span></li></ul></li></ul></li></ul></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><h1>Table of Contents<span class="tocSkip"></span></h1></p>
<div class="toc"><ul class="toc-item"><li><span><a href="#Decoder" data-toc-modified-id="Decoder-1"><span class="toc-item-num">1&nbsp;&nbsp;</span>Decoder</a></span></li><li><span><a href="#Tacotron2-Model" data-toc-modified-id="Tacotron2-Model-2"><span class="toc-item-num">2&nbsp;&nbsp;</span>Tacotron2 Model</a></span></li><li><span><a href="#Tests" data-toc-modified-id="Tests-3"><span class="toc-item-num">3&nbsp;&nbsp;</span>Tests</a></span><ul class="toc-item"><li><span><a href="#Test-without-f0s,-forward-pass" data-toc-modified-id="Test-without-f0s,-forward-pass-3.1"><span class="toc-item-num">3.1&nbsp;&nbsp;</span>Test without f0s, forward pass</a></span></li><li><span><a href="#Test-without-f0s,-inference" data-toc-modified-id="Test-without-f0s,-inference-3.2"><span class="toc-item-num">3.2&nbsp;&nbsp;</span>Test without f0s, inference</a></span></li><li><span><a href="#Test-with-f0s" data-toc-modified-id="Test-with-f0s-3.3"><span class="toc-item-num">3.3&nbsp;&nbsp;</span>Test with f0s</a></span></li><li><span><a href="#Testing-n_frames_per_step" data-toc-modified-id="Testing-n_frames_per_step-3.4"><span class="toc-item-num">3.4&nbsp;&nbsp;</span>Testing n_frames_per_step</a></span><ul class="toc-item"><li><span><a href="#Forward-pass" data-toc-modified-id="Forward-pass-3.4.1"><span class="toc-item-num">3.4.1&nbsp;&nbsp;</span>Forward pass</a></span></li><li><span><a href="#Test-inference-with-n_frames_per_step->-1" data-toc-modified-id="Test-inference-with-n_frames_per_step->-1-3.4.2"><span class="toc-item-num">3.4.2&nbsp;&nbsp;</span>Test inference with n_frames_per_step &gt; 1</a></span></li><li><span><a href="#Test-inference-with-f0s-and-n_frames_per_step->-1" data-toc-modified-id="Test-inference-with-f0s-and-n_frames_per_step->-1-3.4.3"><span class="toc-item-num">3.4.3&nbsp;&nbsp;</span>Test inference with f0s and n_frames_per_step &gt; 1</a></span></li></ul></li></ul></li></ul></div>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Postnet" class="doc_header"><code>class</code> <code>Postnet</code><a href="https://github.com/uberduck-ai/uberduck_ml_dev/tree/master/uberduck_ml_dev/models/mellotron.py#L78" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Postnet</code>(<strong><code>hparams</code></strong>) :: <code>Module</code></p>
</blockquote>
<p>Postnet</p>
<ul>
<li>Five 1-d convolution with 512 channels and kernel size 5</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Prenet" class="doc_header"><code>class</code> <code>Prenet</code><a href="https://github.com/uberduck-ai/uberduck_ml_dev/tree/master/uberduck_ml_dev/models/mellotron.py#L146" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Prenet</code>(<strong><code>in_dim</code></strong>, <strong><code>sizes</code></strong>) :: <code>Module</code></p>
</blockquote>
<p>Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in
a tree structure. You can assign the submodules as regular attributes::</p>

<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super(Model, self).__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))

</code></pre>
<p>Submodules assigned in this way will be registered, and will have their
parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>:ivar training: Boolean represents whether this module is in training or
                evaluation mode.
:vartype training: bool</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Encoder" class="doc_header"><code>class</code> <code>Encoder</code><a href="https://github.com/uberduck-ai/uberduck_ml_dev/tree/master/uberduck_ml_dev/models/mellotron.py#L164" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Encoder</code>(<strong><code>hparams</code></strong>) :: <code>Module</code></p>
</blockquote>
<p>Encoder module:</p>
<ul>
<li>Three 1-d convolution banks</li>
<li>Bidirectional LSTM</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Decoder">Decoder<a class="anchor-link" href="#Decoder"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Decoder" class="doc_header"><code>class</code> <code>Decoder</code><a href="https://github.com/uberduck-ai/uberduck_ml_dev/tree/master/uberduck_ml_dev/models/mellotron.py#L240" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Decoder</code>(<strong><code>hparams</code></strong>) :: <code>Module</code></p>
</blockquote>
<p>Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in
a tree structure. You can assign the submodules as regular attributes::</p>

<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super(Model, self).__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))

</code></pre>
<p>Submodules assigned in this way will be registered, and will have their
parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>:ivar training: Boolean represents whether this module is in training or
                evaluation mode.
:vartype training: bool</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tacotron2-Model">Tacotron2 Model<a class="anchor-link" href="#Tacotron2-Model"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Tacotron2" class="doc_header"><code>class</code> <code>Tacotron2</code><a href="https://github.com/uberduck-ai/uberduck_ml_dev/tree/master/uberduck_ml_dev/models/mellotron.py#L686" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Tacotron2</code>(<strong><code>hparams</code></strong>) :: <a href="/uberduck_ml_dev/models.base.html#TTSModel"><code>TTSModel</code></a></p>
</blockquote>
<p>Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in
a tree structure. You can assign the submodules as regular attributes::</p>

<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super(Model, self).__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))

</code></pre>
<p>Submodules assigned in this way will be registered, and will have their
parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>:ivar training: Boolean represents whether this module is in training or
                evaluation mode.
:vartype training: bool</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tests">Tests<a class="anchor-link" href="#Tests"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-without-f0s,-forward-pass">Test without f0s, forward pass<a class="anchor-link" href="#Test-without-f0s,-forward-pass"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">set_hparam</span><span class="p">(</span><span class="s2">&quot;include_f0&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">ljs_values</span> <span class="o">=</span> <span class="n">DEFAULTS</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="n">ljs_values</span><span class="p">[</span><span class="s2">&quot;n_speakers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ljs_hparams</span> <span class="o">=</span> <span class="n">HParams</span><span class="p">(</span><span class="o">**</span><span class="n">ljs_values</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Tacotron2</span><span class="p">(</span><span class="n">ljs_hparams</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">uberduck_ml_dev.text.util</span> <span class="kn">import</span> <span class="n">text_to_sequence</span>

<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Foo bar baz&quot;</span>
<span class="n">sequence</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
    <span class="p">[</span><span class="n">text_to_sequence</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">cleaner_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;english_cleaners&quot;</span><span class="p">])]</span>
<span class="p">)</span>
<span class="n">input_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)])</span>
<span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">max_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="n">output_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">50</span><span class="p">])</span>
<span class="n">speaker_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
<span class="n">batch</span> <span class="o">=</span> <span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">input_lengths</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">output_lengths</span><span class="p">,</span> <span class="n">speaker_ids</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
<span class="n">mel</span><span class="p">,</span> <span class="n">mel_postnet</span><span class="p">,</span> <span class="n">gate</span><span class="p">,</span> <span class="n">align</span> <span class="o">=</span> <span class="n">out</span>
<span class="k">assert</span> <span class="n">mel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">80</span>
<span class="k">assert</span> <span class="n">mel_postnet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">80</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-without-f0s,-inference">Test without f0s, inference<a class="anchor-link" href="#Test-without-f0s,-inference"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">to_arpabet</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">g2p_en</span> <span class="kn">import</span> <span class="n">G2p</span>

    <span class="n">g2p</span> <span class="o">=</span> <span class="n">G2p</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2"> </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="se">}}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;,.&quot;</span> <span class="k">else</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">g2p</span><span class="p">(</span><span class="n">text</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">arpa_text</span> <span class="o">=</span> <span class="n">to_arpabet</span><span class="p">(</span>
    <span class="s2">&quot;Well you know, as you know, the web&#39;s a pretty miraculous thing. And it was a very simple paradigm that was invented which was.&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">arpa_text</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{ W EH1 L } { Y UW1 } { N OW1 } , { AE1 Z } { Y UW1 } { N OW1 } , { DH AH0 } { W EH1 B Z } { AH0 } { P R IH1 T IY0 } { M ER0 AE1 K Y AH0 L AH0 S } { TH IH1 NG } . { AH0 N D } { IH1 T } { W AA1 Z } { AH0 } { V EH1 R IY0 } { S IH1 M P AH0 L } { P EH1 R AH0 D AY2 M } { DH AE1 T } { W AA1 Z } { IH0 N V EH1 N T AH0 D } { W IH1 CH } { W AA1 Z } .
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sequence</span> <span class="o">=</span> <span class="n">text_to_sequence</span><span class="p">(</span><span class="n">arpa_text</span><span class="p">,</span> <span class="n">cleaner_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;english_cleaners&quot;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">loaded_mel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;test/fixtures/stevejobs-1.pt&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">loaded_mel</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">out_postnet</span><span class="p">,</span> <span class="n">gate</span><span class="p">,</span> <span class="n">attention</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
            <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">sequence</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">])]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">out_postnet</span><span class="p">,</span> <span class="n">gate</span><span class="p">,</span> <span class="n">attention</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
            <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">sequence</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">])]</span>
        <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>torch.Size([80, 566])
Warning! Reached max decoder steps
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ljs_values</span> <span class="o">=</span> <span class="n">DEFAULTS</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="n">ljs_values</span><span class="p">[</span><span class="s2">&quot;n_speakers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ljs_hparams</span> <span class="o">=</span> <span class="n">HParams</span><span class="p">(</span><span class="o">**</span><span class="n">ljs_values</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-with-f0s">Test with f0s<a class="anchor-link" href="#Test-with-f0s"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">DEFAULTS</span><span class="o">.</span><span class="n">set_hparam</span><span class="p">(</span><span class="s2">&quot;include_f0&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Tacotron2</span><span class="p">(</span><span class="n">DEFAULTS</span><span class="p">)</span>
<span class="c1"># loaded = torch.load(&quot;../mellotron_ljs.pt&quot;, map_location=&quot;cpu&quot;)</span>
<span class="c1"># model.load_state_dict(loaded[&quot;state_dict&quot;])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">uberduck_ml_dev.models.common</span> <span class="kn">import</span> <span class="n">MelSTFT</span>

<span class="n">melstft</span> <span class="o">=</span> <span class="n">MelSTFT</span><span class="p">(</span><span class="n">filter_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">hop_length</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">win_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>

<span class="c1"># from IPython.display import Audio</span>
<span class="c1"># Audio(melstft.griffin_lim(out_postnet[0]), rate=22050)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">uberduck_ml_dev.data_loader</span> <span class="kn">import</span> <span class="n">TextMelDataset</span><span class="p">,</span> <span class="n">TextMelCollate</span>

<span class="n">loader</span> <span class="o">=</span> <span class="n">TextMelDataset</span><span class="p">(</span>
    <span class="s2">&quot;test/fixtures/val.txt&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;english_cleaners&quot;</span><span class="p">],</span>
    <span class="mf">0.0</span><span class="p">,</span>
    <span class="mi">80</span><span class="p">,</span>
    <span class="mi">22050</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">8000</span><span class="p">,</span>
    <span class="mi">1024</span><span class="p">,</span>
    <span class="mi">256</span><span class="p">,</span>
    <span class="mi">1024</span><span class="p">,</span>
    <span class="n">include_f0</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">collate_fn</span> <span class="o">=</span> <span class="n">TextMelCollate</span><span class="p">(</span><span class="n">include_f0</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Well you know, as you know, the web&#39;s a pretty miraculous thing. And it was a very simple paradigm that was invented which was.&quot;</span>
<span class="n">arpabet_text</span> <span class="o">=</span> <span class="s2">&quot;{ W EH1 L } { Y UW1 } { N OW1 } , { AE1 Z } { Y UW1 } { N OW1 } , { DH AH0 } { W EH1 B Z } { AH0 } { P R IH1 T IY0 } { M ER0 AE1 K Y AH0 L AH0 S } { TH IH1 NG } . { AH0 N D } { IH1 T } { W AA1 Z } { AH0 } { V EH1 R IY0 } { S IH1 M P AH0 L } { P EH1 R AH0 D AY2 M } { DH AE1 T } { W AA1 Z } { IH0 N V EH1 N T AH0 D } { W IH1 CH } { W AA1 Z } .&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<span class="n">pitch_contour</span> <span class="o">=</span> <span class="n">loader</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="kc">None</span><span class="p">]</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parse_batch</span><span class="p">(</span><span class="n">collate_fn</span><span class="p">([</span><span class="n">loader</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>127
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/zwf/code/uberduck-ml-dev/uberduck_ml_dev/data_loader.py:106: UserWarning: The given NumPy array is not writeable, and PyTorch does not support non-writeable tensors. This means you can write to the underlying (supposedly non-writeable) NumPy array using the tensor. You may want to copy the array to protect its data or make it writeable before converting it to a tensor. This type of warning will be suppressed for the rest of this program. (Triggered internally at  ../torch/csrc/utils/tensor_numpy.cpp:143.)
  audio = torch.FloatTensor(wav_data)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">g2p_en</span> <span class="kn">import</span> <span class="n">G2p</span>

<span class="n">g2p</span> <span class="o">=</span> <span class="n">G2p</span><span class="p">()</span>
<span class="n">arpabet_sequence</span> <span class="o">=</span> <span class="n">text_to_sequence</span><span class="p">(</span>
    <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2"> </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="se">}}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;,.&quot;</span> <span class="k">else</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">g2p</span><span class="p">(</span><span class="n">text</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="n">cleaner_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;english_cleaners&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">mel_out</span><span class="p">,</span> <span class="n">mel_out_postnet</span><span class="p">,</span> <span class="n">gate_out</span><span class="p">,</span> <span class="n">rhythm</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1"># rhythm = rhythm.permute(1, 0, 2)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">loaded_mel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;test/fixtures/stevejobs-1.pt&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">loaded_mel</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">sequence</span> <span class="o">=</span> <span class="n">text_to_sequence</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">cleaner_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;english_cleaners&quot;</span><span class="p">])</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">input_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">arpabet_sequence</span><span class="p">]),</span>
        <span class="mi">0</span><span class="p">,</span>  <span class="c1"># loaded_mel[None],</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">2</span><span class="p">]),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pitch_contour</span><span class="p">),</span>
    <span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">input_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">arpabet_sequence</span><span class="p">]),</span>
        <span class="mi">0</span><span class="p">,</span>  <span class="c1"># loaded_mel[None],</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">2</span><span class="p">]),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pitch_contour</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="c1"># input_ = [torch.LongTensor([sequence]), loaded_mel[None], torch.LongTensor([0]), pitch_contour]</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>torch.Size([80, 566])
Warning! Reached max decoder steps
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Testing-n_frames_per_step">Testing n_frames_per_step<a class="anchor-link" href="#Testing-n_frames_per_step"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">DEFAULTS</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
<span class="n">config</span><span class="p">[</span><span class="s2">&quot;n_frames_per_step_initial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">config</span><span class="p">[</span><span class="s2">&quot;include_f0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">hp</span> <span class="o">=</span> <span class="n">HParams</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
<span class="n">taco</span> <span class="o">=</span> <span class="n">Tacotron2</span><span class="p">(</span><span class="n">hp</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{&#39;n_symbols&#39;: 185, &#39;symbols_embedding_dim&#39;: 512, &#39;mask_padding&#39;: True, &#39;fp16_run&#39;: False, &#39;n_mel_channels&#39;: 80, &#39;encoder_kernel_size&#39;: 5, &#39;encoder_n_convolutions&#39;: 3, &#39;encoder_embedding_dim&#39;: 512, &#39;coarse_n_frames_per_step&#39;: None, &#39;n_frames_per_step_initial&#39;: 7, &#39;decoder_rnn_dim&#39;: 1024, &#39;prenet_dim&#39;: 256, &#39;prenet_f0_n_layers&#39;: 1, &#39;prenet_f0_dim&#39;: 1, &#39;prenet_f0_kernel_size&#39;: 1, &#39;prenet_rms_dim&#39;: 0, &#39;prenet_fms_kernel_size&#39;: 1, &#39;max_decoder_steps&#39;: 1000, &#39;gate_threshold&#39;: 0.5, &#39;p_attention_dropout&#39;: 0.1, &#39;p_decoder_dropout&#39;: 0.1, &#39;p_teacher_forcing&#39;: 1.0, &#39;pos_weight&#39;: None, &#39;attention_rnn_dim&#39;: 1024, &#39;attention_dim&#39;: 128, &#39;attention_location_n_filters&#39;: 32, &#39;attention_location_kernel_size&#39;: 31, &#39;postnet_embedding_dim&#39;: 512, &#39;postnet_kernel_size&#39;: 5, &#39;postnet_n_convolutions&#39;: 5, &#39;n_speakers&#39;: 123, &#39;speaker_embedding_dim&#39;: 128, &#39;with_gst&#39;: True, &#39;ref_enc_filters&#39;: [32, 32, 64, 64, 128, 128], &#39;ref_enc_size&#39;: [3, 3], &#39;ref_enc_strides&#39;: [2, 2], &#39;ref_enc_pad&#39;: [1, 1], &#39;ref_enc_gru_size&#39;: 128, &#39;token_embedding_size&#39;: 256, &#39;token_num&#39;: 10, &#39;num_heads&#39;: 8, &#39;include_f0&#39;: False}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Forward-pass">Forward pass<a class="anchor-link" href="#Forward-pass"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">uberduck_ml_dev.text.util</span> <span class="kn">import</span> <span class="n">text_to_sequence</span>

<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Foo bar baz&quot;</span>
<span class="n">text2</span> <span class="o">=</span> <span class="s2">&quot;Your mom&quot;</span>
<span class="n">sequence</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">text_to_sequence</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">cleaner_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;english_cleaners&quot;</span><span class="p">]),</span>
        <span class="n">text_to_sequence</span><span class="p">(</span><span class="n">text2</span><span class="p">,</span> <span class="n">cleaner_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;english_cleaners&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">input_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">text2</span><span class="p">)])</span>
<span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
<span class="n">max_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="n">output_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">35</span><span class="p">,</span> <span class="mi">15</span><span class="p">])</span>
<span class="n">speaker_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">batch</span> <span class="o">=</span> <span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">input_lengths</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">output_lengths</span><span class="p">,</span> <span class="n">speaker_ids</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">taco</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
<span class="n">mel</span><span class="p">,</span> <span class="n">mel_postnet</span><span class="p">,</span> <span class="n">gate</span><span class="p">,</span> <span class="n">align</span> <span class="o">=</span> <span class="n">out</span>
<span class="k">assert</span> <span class="n">mel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">80</span>
<span class="k">assert</span> <span class="n">mel_postnet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">80</span>


<span class="k">class</span> <span class="nc">Tacotron2Loss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos_weight</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_weight</span> <span class="o">=</span> <span class="n">pos_weight</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">mel_target</span><span class="p">,</span> <span class="n">gate_target</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mel_target</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">gate_target</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">gate_target</span> <span class="o">=</span> <span class="n">gate_target</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mel_out</span><span class="p">,</span> <span class="n">mel_out_postnet</span><span class="p">,</span> <span class="n">gate_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model_output</span>
        <span class="n">gate_out</span> <span class="o">=</span> <span class="n">gate_out</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">mel_out</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mel_target</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mel_out_postnet</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">mel_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()(</span><span class="n">mel_out</span><span class="p">,</span> <span class="n">mel_target</span><span class="p">)</span> <span class="o">+</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()(</span>
            <span class="n">mel_out_postnet</span><span class="p">,</span> <span class="n">mel_target</span>
        <span class="p">)</span>
        <span class="n">gate_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">(</span><span class="n">pos_weight</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_weight</span><span class="p">))(</span>
            <span class="n">gate_out</span><span class="p">,</span> <span class="n">gate_target</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">mel_loss</span><span class="p">,</span> <span class="n">gate_loss</span>


<span class="n">crit</span> <span class="o">=</span> <span class="n">Tacotron2Loss</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mel_loss</span><span class="p">,</span> <span class="n">gate_loss</span> <span class="o">=</span> <span class="n">crit</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[</span><span class="n">targets</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">35</span><span class="p">)])</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">mel_loss</span> <span class="o">+</span> <span class="n">gate_loss</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loss: &quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

<span class="c1"># Now do it again wth a lower n frames per step</span>
<span class="n">taco</span><span class="o">.</span><span class="n">set_current_frames_per_step</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">batch</span> <span class="o">=</span> <span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">input_lengths</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">output_lengths</span><span class="p">,</span> <span class="n">speaker_ids</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">taco</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<span class="n">mel</span><span class="p">,</span> <span class="n">mel_postnet</span><span class="p">,</span> <span class="n">gate</span><span class="p">,</span> <span class="n">align</span> <span class="o">=</span> <span class="n">out</span>
<span class="n">mel_loss</span><span class="p">,</span> <span class="n">gate_loss</span> <span class="o">=</span> <span class="n">crit</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[</span><span class="n">targets</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">35</span><span class="p">)])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>here
torch.Size([2, 80, 35]) torch.Size([2, 80, 35]) torch.Size([2, 80, 35])
loss:  tensor(325.0178, grad_fn=&lt;AddBackward0&gt;)
here
torch.Size([2, 80, 35]) torch.Size([2, 80, 35]) torch.Size([2, 80, 35])
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Test-inference-with-n_frames_per_step-&gt;-1">Test inference with n_frames_per_step &gt; 1<a class="anchor-link" href="#Test-inference-with-n_frames_per_step-&gt;-1"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">arpa_text</span> <span class="o">=</span> <span class="n">to_arpabet</span><span class="p">(</span>
    <span class="s2">&quot;Well you know, as you know, the web&#39;s a pretty miraculous thing. And it was a very simple paradigm that was invented which was.&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">arpa_text</span><span class="p">)</span>
<span class="n">sequence</span> <span class="o">=</span> <span class="n">text_to_sequence</span><span class="p">(</span><span class="n">arpa_text</span><span class="p">,</span> <span class="n">cleaner_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;english_cleaners&quot;</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">taco</span><span class="o">.</span><span class="n">n_frames_per_step_current</span> <span class="o">&gt;</span> <span class="mi">1</span>
<span class="n">taco</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">taco</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">out_postnet</span><span class="p">,</span> <span class="n">gate</span><span class="p">,</span> <span class="n">attention</span> <span class="o">=</span> <span class="n">taco</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
            <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">sequence</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">])]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">out_postnet</span><span class="p">,</span> <span class="n">gate</span><span class="p">,</span> <span class="n">attention</span> <span class="o">=</span> <span class="n">taco</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span>
            <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">sequence</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">])]</span>
        <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{ W EH1 L } { Y UW1 } { N OW1 } , { AE1 Z } { Y UW1 } { N OW1 } , { DH AH0 } { W EH1 B Z } { AH0 } { P R IH1 T IY0 } { M ER0 AE1 K Y AH0 L AH0 S } { TH IH1 NG } . { AH0 N D } { IH1 T } { W AA1 Z } { AH0 } { V EH1 R IY0 } { S IH1 M P AH0 L } { P EH1 R AH0 D AY2 M } { DH AE1 T } { W AA1 Z } { IH0 N V EH1 N T AH0 D } { W IH1 CH } { W AA1 Z } .
Warning! Reached max decoder steps
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Test-inference-with-f0s-and-n_frames_per_step-&gt;-1">Test inference with f0s and n_frames_per_step &gt; 1<a class="anchor-link" href="#Test-inference-with-f0s-and-n_frames_per_step-&gt;-1"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">uberduck_ml_dev.data_loader</span> <span class="kn">import</span> <span class="n">TextMelDataset</span>

<span class="n">loader</span> <span class="o">=</span> <span class="n">TextMelDataset</span><span class="p">(</span>
    <span class="s2">&quot;test/fixtures/val.txt&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;english_cleaners&quot;</span><span class="p">],</span>
    <span class="mf">0.0</span><span class="p">,</span>
    <span class="mi">80</span><span class="p">,</span>
    <span class="mi">22050</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">8000</span><span class="p">,</span>
    <span class="mi">1024</span><span class="p">,</span>
    <span class="mi">256</span><span class="p">,</span>
    <span class="mi">1024</span><span class="p">,</span>
    <span class="n">include_f0</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">pitch_contour</span> <span class="o">=</span> <span class="n">loader</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="kc">None</span><span class="p">]</span>
<span class="n">arpa_text</span> <span class="o">=</span> <span class="n">to_arpabet</span><span class="p">(</span>
    <span class="s2">&quot;Well you know, as you know, the web&#39;s a pretty miraculous thing. And it was a very simple paradigm that was invented which was.&quot;</span>
<span class="p">)</span>
<span class="n">sequence</span> <span class="o">=</span> <span class="n">text_to_sequence</span><span class="p">(</span><span class="n">arpa_text</span><span class="p">,</span> <span class="n">cleaner_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;english_cleaners&quot;</span><span class="p">])</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">input_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">sequence</span><span class="p">]),</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">2</span><span class="p">]),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pitch_contour</span><span class="p">),</span>
    <span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">input_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">arpabet_sequence</span><span class="p">]),</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">2</span><span class="p">]),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pitch_contour</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda:0&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">taco</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Warning! Reached max decoder steps
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

